<?xml version="1.0" encoding="utf-8"?>
<comp:VNCPanel 
	xmlns:comp="net.alexanderadam.airvnc.view.*" xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" resize="resize()"
	xmlns:ns1="fvnc.*" backgroundColor="#7C7C7C" rollOver="{actionpanel.visible = true}" rollOut="{actionpanel.visible = false}"
	creationComplete="init()">
	<mx:Script>
		<![CDATA[
			import tw.helpers.flv.SimpleFlvWriter;
			import mx.controls.Alert;
			import mx.core.Window;
			import fvnc.rfb.constants.ProtocolState;
			
			//instantiating our flv writer
			private var myWriter:SimpleFlvWriter = SimpleFlvWriter.getInstance();
			//our interval to record the feed from our webcam
			private var recordInterval:uint;
			//reference to our current video file
			private var curVidFile:File;
			
			private var connected:Boolean;
			private var videoWriter:SimpleFlvWriter = SimpleFlvWriter.getInstance();
			
			private var videoWidth:uint = 640;
			private var videoHeight:uint = 480;
			
			private function resize():void {
				if(this.connected) {
					vnc.close();
					connect();
				}
			}
			
			private function init():void {
				connect();
				trace('vnc connected');
			}
			
			public function connect():Boolean {
				if(host == '' || password == '') {
					Alert.show('Host or password not set!');
					return false;
				}
				
				vnc.host = this.host;
				vnc.password = this.password;
				//this.title = 'Live Session: ' + this.host;
				
				vnc.connect();
				vnc.getRFB().addEventListener(IOErrorEvent.IO_ERROR, handleIOError, false, 1);
				
				lblVNCStatus.visible = true;
				lblVNCStatus.text = 'connecting ...';
				lblVNCStatus.setStyle('color', 0x01CF00);
				if(vnc.hasEventListener('VNCConnected') == false) {
					vnc.addEventListener('VNCConnected', function():void {
						btnConnect.label = 'Disconnect';
						btnConnect.enabled = true;
						lblVNCStatus.text = 'connected';
						lblVNCStatus.setStyle('color', 0x01CF00);
						connected = true;
					});
				}
				
				return true;
			}
			
			private function handleIOError(event:IOErrorEvent):void {
				if ( vnc.getState() == ProtocolState.NOT_CONNECTED )
				{
					lblVNCStatus.text = 'Could not connect';
					lblVNCStatus.setStyle('color', 0xFF0000);
					vnc.close();
				}
				else
				{
					trace( event.text );
					lblVNCStatus.text = 'Could not connect';
					lblVNCStatus.setStyle('color', 0xFF0000);
					vnc.close();
				}
				btnConnect.label = 'Reconnect';
				btnConnect.enabled = true;
				connected = false;
				event.stopImmediatePropagation();
			}
			
			private function switchVNCStatus():void {
				btnConnect.enabled = false;
				if(connected) {
					btnConnect.label = 'Connect';
					lblVNCStatus.text = 'disconnected';
					vnc.close();
					connected = false;
					btnConnect.enabled = true;
				} else {
					connect();
				}
			}
			
			private function startLiveSession():void {
				// close current session
				if(this.connected) {
					vnc.close();
				}
				
				// create window
				var livesession:Window = new Window();
				livesession.title = 'Live Session';
				livesession.open();
				livesession.maximize();
				livesession.addEventListener(Event.CLOSE, function():void {
					connect();
				});
				
				// add vnc viewer
				var livevnc:FVNC = new FVNC();
				livesession.addChild(livevnc);
				livevnc.host = this.host;
				livevnc.password = this.password;
				livevnc.fitToScreen = true;
				livevnc.percentWidth = 100;
				livevnc.percentHeight = 100;
				livevnc.connect();
			}
			
			private function recordVideo():void {
				if(record_btn.label == "Record"){
					
					curVidFile = File.createTempFile();
					myWriter.createFile(curVidFile,  videoWidth,videoHeight, 2);
					recordInterval = setInterval(recordVid, 100);
					record_btn.label = "Stop";
					
				}else{
					
					clearInterval(recordInterval);
					myWriter.closeFile();
					var pat:RegExp = /\./g;
					var newFileNameStr:String = this.host + '_' + new Date().getTime().toString() + '.flv';//curVidFile.name.split(".tmp").join(".flv");
					var desFile:File = new File(File.desktopDirectory.nativePath +"\\" + newFileNameStr);
					curVidFile.copyTo(desFile);
					record_btn.label = "Record";
				}
			}
			
			private function recordVid():void {
				var rec:Rectangle = vnc.getScreenBounds();
				
				
				var m:Matrix = new Matrix();
			 	var sx:Number =  videoWidth / rec.width;
			  	var sy:Number = videoHeight / rec.height;
			 	m.scale(sx, sy);
				
				var snapshot:BitmapData = new BitmapData(videoWidth, videoHeight, true);
				snapshot.draw(vnc.getScreenImage(), m);
				myWriter.saveFrame( snapshot );
			}
		]]>
	</mx:Script>
	
	<mx:Fade id="fadeOut" duration="800" alphaFrom="1.0" alphaTo="0.0"/>
    <mx:Fade id="fadeIn" duration="800" alphaFrom="0.0" alphaTo="1.0"/>
	
	<mx:Canvas id="content" width="100%" height="100%" verticalScrollPolicy="off" horizontalScrollPolicy="off">
		<ns1:FVNC 
				id="vnc" left="0" right="0" fitToScreen="true" viewOnly="true" height="100%"
				top="0" width="100%" toolTip="Click me to enable a remote session" click="startLiveSession()" borderColor="#000000" borderThickness="1">
		</ns1:FVNC>
		<mx:Canvas id="actionpanel" x="0" width="100%" height="57" bottom="0" backgroundColor="#000000" visible="false" hideEffect="{fadeOut}" showEffect="{fadeIn}" borderStyle="solid" borderColor="#9A9A9A" alpha="0.7">
			<mx:Button x="10" y="19" label="Disconnect" id="btnConnect" enabled="false" click="switchVNCStatus()"/>
			<mx:Label x="106.5" y="1" id="lblVNCStatus" visible="true" text="disconnected"/>
			<mx:Button x="214" y="19" label="Record" id="record_btn" click="recordVideo()"/>
		</mx:Canvas>
	</mx:Canvas>
</comp:VNCPanel>
